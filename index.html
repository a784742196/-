<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>即时兑换汇率对比（多链版）</title>
<style>
  body { font-family: -apple-system, "Helvetica Neue", Arial; margin: 12px; }
  input, button, select, textarea { font-size: 15px; padding: 4px; border-radius: 4px; border: 1px solid #ccc; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align:left; }
  .ok { color: green; } .err { color: #c00; }
  .small { font-size: 13px; color: #666; }
  .adapter-item { border: 1px solid #eee; padding: 8px; margin: 6px 0; border-radius: 4px; background: #f9f9f9; }
  .section-title { margin-top: 20px; border-bottom: 2px solid #555; padding-bottom: 5px; }
  .config-area { border:1px solid #aaa;padding:8px;margin-top:16px;background:#f5f5f5;border-radius:4px; }
  .summary { margin-top: 15px; padding: 10px; border: 1px solid #eee; border-radius: 4px; background: #f0f8ff; }
  .summary b { font-size: 1.1em; }
  .best-mark { color: green; font-weight: bold; margin-left: 4px; }
  .small-muted { font-size:12px;color:#999;margin-left:6px;}
  .output-cell { font-size: 1.05em; }
  .output-cell.best { font-size: 1.15em; }
</style>
</head>
<body>
<h2>即时兑换汇率对比（多链版）</h2>

<div>
  <label>币种From:<input id="from" value="BTC" style="width:80px"></label>
  <label>链From:<input id="fromNetwork" value="ETH" style="width:80px"></label>
  <label>币种To:<input id="to" value="USDT" style="width:80px"></label>
  <label>链To:<input id="toNetwork" value="SOL" style="width:80px"></label>
  <label>数量:<input id="amount" value="1" style="width:80px"></label>

  <label style="margin-left:12px;">
    <input type="radio" name="mode" id="modeFloating" value="floating" checked> 查浮动
  </label>
  <label>
    <input type="radio" name="mode" id="modeLocked" value="locked"> 查锁定
  </label>

  <button id="compare" style="margin-left:8px;">一键比价</button>
  <button id="copyJson" style="margin-left:8px; display:none;">复制 JSON</button>
</div>

<div id="status" class="small" style="margin:10px 0;">请设置 WORKER_URL</div>

<h4 style="color:#007bff;">浮动汇率</h4>
<table id="floatingTable"><thead><tr><th>交易所</th><th>预估输出量（总价）</th><th>操作</th></tr></thead><tbody></tbody></table>
<div id="floatingSummary" class="summary" style="display:none;"></div>

<h4 style="color:#28a745;">锁定汇率</h4>
<table id="lockedTable"><thead><tr><th>交易所</th><th>预估输出量（总价）</th><th>操作</th></tr></thead><tbody></tbody></table>
<div id="lockedSummary" class="summary" style="display:none;"></div>

<div class="config-area">
  <h3 class="section-title">交易所适配器管理（需密码）</h3>
  <div>
    <input id="adminPass" type="password" placeholder="输入管理密码" style="width:140px;">
    <button id="loadFromKV">从后端加载配置</button>
    <button id="saveToKV">保存到后端</button>
    <button id="addAdapter">新增交易所</button>
  </div>
  <div class="small">可添加或删除自定义交易所 API。配置将保存到 Cloudflare Worker KV 中。</div>
  <div id="adapterList"></div>
</div>

<h2>全局配置管理</h2>
<div id="admin-panel" class="config-area">
  <input id="admin-pass" placeholder="管理密码" type="password" style="width:140px;" />
  <input id="api-key" placeholder="ChangeNOW API Key" style="width:240px;" />
  <button onclick="saveConfig()">保存全局配置</button>
  <div class="small-muted">全局 API Key 仅作 adapter 未提供 apiKey 时的回退。</div>
</div>

<script>
const WORKER_URL = 'https://cold-block-7484.yanfei6868.workers.dev';
let adapters = [];
let queryPair = {}; 
let lastResults = null;

function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;')
          .replace(/</g, '&lt;').replace(/>/g, '&gt;')
          .replace(/'/g, '&#39;');
}

/* --- renderAdapters（略，保持原样） --- */
/* ...（此处省略到 showResults 部分，与原版一致）... */

/* ---------- showResults ---------- */
function showResults(results) {
  const floating = (results?.results || []).filter(r => r?.rateType === 'floating');
  const locked = (results?.results || []).filter(r => r?.rateType === 'locked');
  
  const sortFn = (a, b) => (b.outputAmount ?? -Infinity) - (a.outputAmount ?? -Infinity);
  
  floating.sort(sortFn);
  locked.sort(sortFn);
  
  renderTable(floating, '#floatingTable tbody');
  renderTable(locked, '#lockedTable tbody');
  
  renderSummary(floating.filter(r => r.ok), '#floatingSummary', floating[0]);
  renderSummary(locked.filter(r => r.ok), '#lockedSummary', locked[0]);
}

/* ---------- 修改后的 renderTable ---------- */
function renderTable(data, selector) {
  const tbody = document.querySelector(selector);
  tbody.innerHTML = '';
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan=3 style="text-align:center;color:#666;">无数据</td></tr>';
    return;
  }

  data.forEach((r, i) => {
    const best = i === 0 && r.ok && r.outputAmount != null;

    // 判断浮动或锁定模式
    const isFloating = (r.rateType || '').toLowerCase() === 'floating';

    // 统一总价逻辑：浮动 -> 乘以数量；锁定 -> 保持
    let displayAmount = null;
    if (r.ok && r.outputAmount != null) {
      const raw = Number(r.outputAmount);
      displayAmount = isFloating ? raw * queryPair.amount : raw;
    }

    const outputDisplay = displayAmount != null
      ? displayAmount.toFixed(6) + ' ' + queryPair.to
      : `<span class="err">${escapeHtml(r.error || '失败')}</span>`;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(r.name || '-')}${best ? '<span class="best-mark">Best</span>' : ''}</td>
      <td class="output-cell ${best ? 'best' : ''}" 
          style="font-weight:${best ? 'bold' : 'normal'}; color:${best ? 'green' : 'inherit'};">
        ${outputDisplay}
      </td>
      <td>${r.ok && r.link && /^https?:\/\//i.test(r.link) 
        ? `<a href="${escapeHtml(r.link)}" target="_blank" rel="noopener">前往</a>` 
        : '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ---------- renderSummary ---------- */
function renderSummary(data, selector, bestResult) {
  const div = document.querySelector(selector);
  if (!data.length || !bestResult?.outputAmount) {
    div.style.display = 'none';
    return;
  }
  div.style.display = 'block';
  div.innerHTML = `
    <p>输入: <b>${queryPair.amount} ${queryPair.from}</b></p>
    <p>最优 (<b>${escapeHtml(bestResult.name)}</b>): 
       <b style="color:green; font-size: 1.2em;">${
         ((bestResult.rateType || '').toLowerCase() === 'floating'
           ? (Number(bestResult.outputAmount) * queryPair.amount)
           : Number(bestResult.outputAmount)
         ).toFixed(6)
       } ${queryPair.to}</b>
    </p>
  `;
}
</script>
</body>
</html>
