<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å³æ—¶å…‘æ¢æ±‡ç‡å¯¹æ¯”ï¼ˆå¤šé“¾ç‰ˆï¼‰</title>
<style>
Â Â body { font-family: -apple-system, "Helvetica Neue", Arial; margin: 12px; }
Â Â input, button, select { font-size: 15px; padding: 4px; border-radius: 4px; border: 1px solid #ccc; }
Â Â table { width: 100%; border-collapse: collapse; margin-top: 10px; }
Â Â th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align:left; }
Â Â .ok { color: green; } .err { color: #c00; }
Â Â .small { font-size: 13px; color: #666; }
Â Â .adapter-item { border: 1px solid #eee; padding: 8px; margin: 6px 0; border-radius: 4px; background: #f9f9f9; }
Â Â .section-title { margin-top: 20px; border-bottom: 2px solid #555; padding-bottom: 5px; }
Â Â .config-area { border:1px solid #aaa;padding:8px;margin-top:16px;background:#f5f5f5;border-radius:4px; }
</style>
</head>
<body>
<h2>ğŸª™ å³æ—¶å…‘æ¢æ±‡ç‡å¯¹æ¯”ï¼ˆå¤šé“¾ç‰ˆï¼‰</h2>

<div>
Â Â <label>å¸ç§From:<input id="from" value="BTC" style="width:80px"></label>
Â Â <label>é“¾From:<input id="fromNetwork" value="ETH" style="width:80px"></label>
Â Â <label>å¸ç§To:<input id="to" value="USDT" style="width:80px"></label>
Â Â <label>é“¾To:<input id="toNetwork" value="SOL" style="width:80px"></label>
Â Â <button id="compare">ä¸€é”®æ¯”ä»·</button>
</div>

<div id="status" class="small" style="margin:10px 0;">å°šæœªæŸ¥è¯¢</div>

<h4 style="color:#007bff;">æµ®åŠ¨æ±‡ç‡</h4>
<table id="floatingTable"><thead><tr><th>äº¤æ˜“æ‰€</th><th>æ±‡ç‡</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>

<h4 style="color:#28a745;">é”å®šæ±‡ç‡</h4>
<table id="lockedTable"><thead><tr><th>äº¤æ˜“æ‰€</th><th>æ±‡ç‡</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>

<div class="config-area">
Â Â <h3 class="section-title">ğŸ”§ äº¤æ˜“æ‰€é€‚é…å™¨ç®¡ç†ï¼ˆéœ€å¯†ç ï¼‰</h3>
Â Â <div>
Â Â Â Â <input id="adminPass" type="password" placeholder="è¾“å…¥ç®¡ç†å¯†ç " style="width:140px;">
Â Â Â Â <button id="loadFromKV">ä»åç«¯åŠ è½½é…ç½®</button>
Â Â Â Â <button id="saveToKV">ä¿å­˜åˆ°åç«¯</button>
Â Â Â Â <button id="addAdapter">æ–°å¢äº¤æ˜“æ‰€</button>
Â Â </div>
Â Â <div class="small">å¯æ·»åŠ æˆ–åˆ é™¤è‡ªå®šä¹‰äº¤æ˜“æ‰€ APIã€‚é…ç½®å°†ä¿å­˜åˆ° Cloudflare Worker KV ä¸­ã€‚</div>
Â Â <div id="adapterList"></div>
</div>

<script>
// âš ï¸ è¯·å°†æ­¤å¤„æ›¿æ¢ä¸ºæ‚¨å®é™…éƒ¨ç½²çš„ Cloudflare Worker URL
const WORKER_URL = 'https://young-pine-f36b.yanfei6868.workers.dev'; 
let adapters = [];

// å¢å¼º HTML å®ä½“è½¬ä¹‰ï¼Œä¿®å¤ XSS é£é™©
function escapeHtml(s){ 
Â Â return s ? s.replace(/&/g, '&amp;')
Â Â Â Â Â Â Â Â Â Â Â Â Â .replace(/"/g,'&quot;')
Â Â Â Â Â Â Â Â Â Â Â Â Â .replace(/</g,'&lt;')
Â Â Â Â Â Â Â Â Â Â Â Â Â .replace(/>/g,'&gt;')
Â Â Â Â Â Â Â Â Â Â Â Â Â .replace(/'/g, '&#39;') 
Â Â Â Â Â Â Â Â Â Â Â : ''; 
}

function renderAdapters() {
Â Â const container = document.getElementById('adapterList');
Â Â container.innerHTML = '';
Â Â adapters.forEach((a, i) => {
Â Â Â Â const div = document.createElement('div');
Â Â Â Â div.className = 'adapter-item';
Â Â Â Â // ç¡®ä¿æ‰€æœ‰æ˜¾ç¤ºçš„å€¼éƒ½ç»è¿‡è½¬ä¹‰
Â Â Â Â div.innerHTML = `
Â Â Â Â Â Â <b>${escapeHtml(a.name || ('é€‚é…å™¨ ' + (i+1)))}</b><br>
Â Â Â Â Â Â <div class="small">URLæ¨¡æ¿: <input data-i="${i}" class="url" value="${escapeHtml(a.urlTemplate||'')}" style="width:90%"></div>
Â Â Â Â Â Â <div class="small">é“¾æ¥æ¨¡æ¿: <input data-i="${i}" class="linkTemplate" value="${escapeHtml(a.linkTemplate||'')}" style="width:90%"></div>
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>ç±»å‹:
Â Â Â Â Â Â Â Â Â Â <select data-i="${i}" class="rateType">
Â Â Â Â Â Â Â Â Â Â Â Â <option value="floating" ${a.rateType==='floating'?'selected':''}>æµ®åŠ¨</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="locked" ${a.rateType==='locked'?'selected':''}>é”å®š</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <label>è§£æç±»å‹:
Â Â Â Â Â Â Â Â <select data-i="${i}" class="parseType">
Â Â Â Â Â Â Â Â Â Â <option value="json" ${a.parseType==='json'?'selected':''}>json</option>
Â Â Â Â Â Â Â Â Â Â <option value="html_regex" ${a.parseType==='html_regex'?'selected':''}>html_regex</option>
Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â </label>
Â Â Â Â Â Â <label>è·¯å¾„/Regex: <input data-i="${i}" class="parsePath" value="${escapeHtml(a.parsePath||'')}" style="width:60%"></label><br>
Â Â Â Â Â Â <button data-i="${i}" class="del">åˆ é™¤</button>
Â Â Â Â `;
Â Â Â Â container.appendChild(div);
Â Â });

Â Â const update = (e,p)=>{adapters[Number(e.target.dataset.i)][p]=e.target.value;};
Â Â container.querySelectorAll('.url').forEach(inp=>inp.onchange=e=>update(e,'urlTemplate'));
Â Â container.querySelectorAll('.linkTemplate').forEach(inp=>inp.onchange=e=>update(e,'linkTemplate'));
Â Â container.querySelectorAll('.rateType').forEach(sel=>sel.onchange=e=>update(e,'rateType'));
Â Â container.querySelectorAll('.parseType').forEach(sel=>sel.onchange=e=>update(e,'parseType'));
Â Â container.querySelectorAll('.parsePath').forEach(inp=>inp.onchange=e=>update(e,'parsePath'));
Â Â // æ˜¾å¼è½¬ä¸ºæ•°å­—ç´¢å¼•
Â Â container.querySelectorAll('.del').forEach(btn=>btn.onclick=e=>{adapters.splice(Number(e.target.dataset.i),1);renderAdapters();});
}

document.getElementById('addAdapter').onclick = () => {
Â Â // è¡¥å……é“¾å ä½ç¬¦
Â Â adapters.push({ name:'æ–°äº¤æ˜“æ‰€', urlTemplate:'https://api.example.com?from={{from}}&to={{to}}&fromChain={{fromNetwork}}&toChain={{toNetwork}}', method:'GET', parseType:'json', parsePath:'data.rate', linkTemplate:'https://example.com/{{from}}-{{to}}/{{fromNetwork}}-{{toNetwork}}', rateType:'floating' });
Â Â renderAdapters();
};

document.getElementById('loadFromKV').onclick = async () => {
Â Â try {
Â Â Â Â const res = await fetch(`${WORKER_URL}/getConfig`);
Â Â Â Â if (!res.ok) throw new Error(`HTTP é”™è¯¯: ${res.status}`);
Â Â Â Â const data = await res.json();
Â Â Â Â adapters = data.adapters || [];
Â Â Â Â alert('âœ… å·²ä»åç«¯åŠ è½½é…ç½®ï¼Œå…± '+adapters.length+' æ¡');
Â Â Â Â renderAdapters();
Â Â } catch (e) {
Â Â Â Â alert('âŒ ä»åç«¯åŠ è½½é…ç½®å¤±è´¥: '+e.message);
Â Â }
};

document.getElementById('saveToKV').onclick = async () => {
Â Â const pass = document.getElementById('adminPass').value.trim();
Â Â if (!pass) return alert('è¯·è¾“å…¥å¯†ç ');
Â Â try {
Â Â Â Â const res = await fetch(`${WORKER_URL}/saveConfig`, {
Â Â Â Â Â Â method:'POST', headers:{'content-type':'application/json'},
Â Â Â Â Â Â body: JSON.stringify({ password: pass, config:{ adapters } })
Â Â Â Â });
Â Â Â Â const data = await res.json();
Â Â Â Â if (data.ok) alert('âœ… é…ç½®å·²ä¿å­˜åˆ°åç«¯ KV');
Â Â Â Â else alert('âŒ ä¿å­˜å¤±è´¥: '+(data.error||'æœªçŸ¥é”™è¯¯'));
Â Â } catch (e) {
Â Â Â Â Â alert('âŒ ä¿å­˜å¤±è´¥: '+e.message);
Â Â }
};

// =================== æ±‡ç‡æŸ¥è¯¢ ===================
document.getElementById('compare').onclick = async ()=>{
Â Â const from=document.getElementById('from').value.trim().toUpperCase();
Â Â const to=document.getElementById('to').value.trim().toUpperCase();
Â Â const fromNetwork=document.getElementById('fromNetwork').value.trim().toUpperCase();
Â Â const toNetwork=document.getElementById('toNetwork').value.trim().toUpperCase();
Â Â if(!from||!to)return alert('è¯·è¾“å…¥å¸ç§');
Â Â document.getElementById('status').textContent='æŸ¥è¯¢ä¸­...';
Â Â document.querySelector('#floatingTable tbody').innerHTML='';
Â Â document.querySelector('#lockedTable tbody').innerHTML='';
Â Â try{
Â Â Â Â const res=await fetch(WORKER_URL, {
Â Â Â Â Â Â method:'POST', headers:{'content-type':'application/json'},
Â Â Â Â Â Â body: JSON.stringify({ pair:{ from, to, fromNetwork, toNetwork }, adapters })
Â Â Â Â });
Â Â Â Â if (!res.ok) throw new Error(`HTTP é”™è¯¯: ${res.status}`);
Â Â Â Â const results=await res.json();
Â Â Â Â showResults(results);
Â Â Â Â document.getElementById('status').textContent=`âœ… æŸ¥è¯¢å®Œæˆï¼Œå…± ${results.length} æ¡ç»“æœ`;
Â Â }catch(e){
Â Â Â Â document.getElementById('status').textContent='âŒ å¤±è´¥: '+e.message;
Â Â }
};

function showResults(results){
Â Â const floating=results.filter(r=>r.rateType==='floating');
Â Â const locked=results.filter(r=>r.rateType==='locked');
Â Â const sortFn=(a,b)=>{
Â Â Â Â if(a.rate===null&&b.rate===null)return 0;
Â Â Â Â if(a.rate===null)return 1;if(b.rate===null)return -1;return b.rate-a.rate;
Â Â };
Â Â floating.sort(sortFn);locked.sort(sortFn);
Â Â renderTable(floating,'#floatingTable tbody');
Â Â renderTable(locked,'#lockedTable tbody');
}

function renderTable(data,selector){
Â Â const tbody=document.querySelector(selector);tbody.innerHTML='';
Â Â if(!data.length){tbody.innerHTML='<tr><td colspan=3 style="text-align:center;color:#666;">æ— æ•°æ®</td></tr>';return;}
Â Â data.forEach((r,i)=>{
Â Â Â Â const tr=document.createElement('tr');
Â Â Â Â const best=i===0&&r.ok&&r.rate!=null;
Â Â Â Â // ä¿®å¤ XSS é£é™©ï¼šå¯¹ name å’Œ link è¿›è¡Œè½¬ä¹‰
Â Â Â Â const safeName = escapeHtml(r.name);
Â Â Â Â const safeLink = escapeHtml(r.link || '');
Â Â Â Â tr.innerHTML=`
Â Â Â Â Â Â <td>${safeName}</td>
Â Â Â Â Â Â <td>${r.ok&&r.rate!=null?(best?'ğŸ‘‘ <b style="color:red;">'+r.rate+'</b>':r.rate):'<span class="err">'+escapeHtml(r.error||'æ— ')+'</span>'}</td>
Â Â Â Â Â Â <td>${r.ok&&r.link?'<a href="'+safeLink+'" target="_blank">å‰å¾€</a>':'-'}</td>`;
Â Â Â Â tbody.appendChild(tr);
Â Â });
}
</script>
</body>
</html>
