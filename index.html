<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å³æ—¶å…‘æ¢æ±‡ç‡å¯¹æ¯”ï¼ˆå¤šé“¾ç‰ˆï¼‰</title>
<style>
Â Â body { font-family: -apple-system, "Helvetica Neue", Arial; margin: 12px; }
Â Â input, button, select { font-size: 15px; padding: 4px; border-radius: 4px; border: 1px solid #ccc; }
Â Â table { width: 100%; border-collapse: collapse; margin-top: 10px; }
Â Â th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align:left; }
Â Â .ok { color: green; } .err { color: #c00; }
Â Â .small { font-size: 13px; color: #666; }
Â Â .adapter-item { border: 1px solid #eee; padding: 8px; margin: 6px 0; border-radius: 4px; background: #f9f9f9; }
Â Â .section-title { margin-top: 20px; border-bottom: 2px solid #555; padding-bottom: 5px; }
Â Â .config-area { border:1px solid #aaa;padding:8px;margin-top:16px;background:#f5f5f5;border-radius:4px; }
Â Â .summary { margin-top: 15px; padding: 10px; border: 1px solid #eee; border-radius: 4px; background: #f0f8ff; }
Â Â .summary b { font-size: 1.1em; }
Â Â .best-mark { color: green; font-weight: bold; margin-left: 4px; }
</style>
</head>
<body>
<h2>å³æ—¶å…‘æ¢æ±‡ç‡å¯¹æ¯”ï¼ˆå¤šé“¾ç‰ˆï¼‰</h2>

<div>
Â Â <label>å¸ç§From:<input id="from" value="BTC" style="width:80px"></label>
Â Â <label>é“¾From:<input id="fromNetwork" value="ETH" style="width:80px"></label>
Â Â <label>å¸ç§To:<input id="to" value="USDT" style="width:80px"></label>
Â Â <label>é“¾To:<input id="toNetwork" value="SOL" style="width:80px"></label>
Â Â <label>æ•°é‡:<input id="amount" value="1" style="width:80px"></label>
Â Â <button id="compare">ä¸€é”®æ¯”ä»·</button>
Â Â <button id="copyJson" style="margin-left:8px; display:none;">å¤åˆ¶ JSON</button>
</div>

<div id="status" class="small" style="margin:10px 0;">å°šæœªæŸ¥è¯¢</div>

<h4 style="color:#007bff;">æµ®åŠ¨æ±‡ç‡</h4>
<table id="floatingTable"><thead><tr><th>äº¤æ˜“æ‰€</th><th>æ±‡ç‡</th><th>é¢„ä¼°è¾“å‡ºé‡</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>

<div id="floatingSummary" class="summary" style="display:none;"></div>

<h4 style="color:#28a745;">é”å®šæ±‡ç‡</h4>
<table id="lockedTable"><thead><tr><th>äº¤æ˜“æ‰€</th><th>æ±‡ç‡</th><th>é¢„ä¼°è¾“å‡ºé‡</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>

<div id="lockedSummary" class="summary" style="display:none;"></div>

<div class="config-area">
Â Â <h3 class="section-title">äº¤æ˜“æ‰€é€‚é…å™¨ç®¡ç†ï¼ˆéœ€å¯†ç ï¼‰</h3>
Â Â <div>
Â Â Â Â <input id="adminPass" type="password" placeholder="è¾“å…¥ç®¡ç†å¯†ç " style="width:140px;">
Â Â Â Â <button id="loadFromKV">ä»åç«¯åŠ è½½é…ç½®</button>
Â Â Â Â <button id="saveToKV">ä¿å­˜åˆ°åç«¯</button>
Â Â Â Â <button id="addAdapter">æ–°å¢äº¤æ˜“æ‰€</button>
Â Â </div>
Â Â <div class="small">å¯æ·»åŠ æˆ–åˆ é™¤è‡ªå®šä¹‰äº¤æ˜“æ‰€ APIã€‚é…ç½®å°†ä¿å­˜åˆ° Cloudflare Worker KV ä¸­ã€‚</div>
Â Â <div id="adapterList"></div>
</div>

<h2>é…ç½®ç®¡ç†</h2>
<div id="admin-panel">
Â Â <input id="admin-pass" placeholder="ç®¡ç†å¯†ç " type="password" style="width:140px;" />
Â Â <input id="api-key" placeholder="ChangeNOW API Key" style="width:200px;" />
Â Â <button onclick="saveConfig()">ä¿å­˜é…ç½®</button>
</div>

<script>
// è¯·ç¡®ä¿æ­¤å¤„çš„ WORKER_URL æ­£ç¡®æŒ‡å‘æ‚¨çš„ Cloudflare Worker
const WORKER_URL = 'YOUR_WORKER_URL_HERE'; 
let adapters = [];
let queryPair = {}; 
let lastResults = null;

function escapeHtml(s){ 
Â Â return s ? s.replace(/&/g, '&amp;')
Â Â Â Â Â Â Â Â Â Â Â Â Â .replace(/"/g,'&quot;')
Â Â Â Â Â Â Â Â Â Â Â Â Â .replace(/</g,'&lt;')
Â Â Â Â Â Â Â Â Â Â Â Â Â .replace(/>/g,'&gt;')
Â Â Â Â Â Â Â Â Â Â Â Â Â .replace(/'/g, '&#39;') 
Â Â Â Â Â Â Â Â Â Â Â : ''; 
}

function renderAdapters() {
Â Â const container = document.getElementById('adapterList');
Â Â container.innerHTML = '';
Â Â adapters.forEach((a, i) => {
Â Â Â Â const mappingsJson = JSON.stringify(a.mappings || {}, null, 2);
Â Â Â Â const headersJson = JSON.stringify(a.headers || {}, null, 2); // ğŸ”¹ ç¬¬1å¤„ï¼šæ–°å¢ headers åºåˆ—åŒ–

Â Â Â Â const div = document.createElement('div');
Â Â Â Â div.className = 'adapter-item';
Â Â Â Â div.innerHTML = `
Â Â Â Â Â Â <b>${escapeHtml(a.name || ('é€‚é…å™¨ ' + (i+1)))}</b><br>
Â Â Â Â Â Â <div class="small">URLæ¨¡æ¿: <input data-i="<LaTex>${i}" class="url" value="$</LaTex>{escapeHtml(a.urlTemplate||'')}" style="width:90%"></div>
Â Â Â Â Â Â <div class="small">é“¾æ¥æ¨¡æ¿: <input data-i="<LaTex>${i}" class="linkTemplate" value="$</LaTex>{escapeHtml(a.linkTemplate||'')}" style="width:90%"></div>
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>ç±»å‹:
Â Â Â Â Â Â Â Â Â Â <select data-i="${i}" class="rateType">
Â Â Â Â Â Â Â Â Â Â Â Â <option value="floating" ${a.rateType==='floating'?'selected':''}>æµ®åŠ¨</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="locked" ${a.rateType==='locked'?'selected':''}>é”å®š</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <label>è§£æç±»å‹:
Â Â Â Â Â Â Â Â <select data-i="${i}" class="parseType">
Â Â Â Â Â Â Â Â Â Â <option value="json" ${a.parseType==='json'?'selected':''}>json</option>
Â Â Â Â Â Â Â Â Â Â <option value="html_regex" ${a.parseType==='html_regex'?'selected':''}>html_regex</option>
Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â </label>
Â Â Â Â Â Â <label>è·¯å¾„/Regex: <input data-i="<LaTex>${i}" class="parsePath" value="$</LaTex>{escapeHtml(a.parsePath||'')}" style="width:60%"></label><br>
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>å¸ç§/é“¾åæ˜ å°„ (Mappings): <textarea data-i="${i}" class="mappings" style="width:90%; height: 80px;" placeholder='{"BTC": "XBT", "ETH": "ETHEREUM"}'></textarea></label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>API Key: <input data-i="<LaTex>${i}" class="apiKey" value="$</LaTex>{escapeHtml(a.apiKey||'')}" style="width:90%"></label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <!-- ğŸ”¹ ç¬¬1å¤„ï¼šæ–°å¢è‡ªå®šä¹‰ Headers è¾“å…¥æ¡† -->
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>è‡ªå®šä¹‰ Headers(JSON):
Â Â Â Â Â Â Â Â Â Â <textarea data-i="${i}" class="headers" style="width:90%; height:70px;"
Â Â Â Â Â Â Â Â Â Â Â Â placeholder='{"x-changenow-api-key":"{{apiKey}}"}'></textarea>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <button data-i="${i}" class="del">åˆ é™¤</button>
Â Â Â Â `;
Â Â Â Â div.querySelector('.mappings').value = mappingsJson;
Â Â Â Â div.querySelector('.headers').value = headersJson; // ğŸ”¹ ç¬¬1å¤„ï¼šèµ‹å€¼ headers
Â Â Â Â container.appendChild(div);
Â Â });

Â Â const update = (e,p)=>{
Â Â Â Â const i = Number(e.target.dataset.i);
Â Â Â Â // ğŸ”¹ ç¬¬2å¤„ï¼šæ”¯æŒè§£æ headers å­—æ®µ
Â Â Â Â if (p === 'mappings' || p === 'headers') {
Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â adapters[i][p] = JSON.parse(e.target.value || '{}');
Â Â Â Â Â Â } catch(err) {
Â Â Â Â Â Â Â Â alert('é…ç½®æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON å¯¹è±¡: ' + err.message);
Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â }
Â Â Â Â } else {
Â Â Â Â Â Â adapters[i][p] = e.target.value;
Â Â Â Â }
Â Â };
Â Â 
Â Â container.querySelectorAll('.url').forEach(inp=>inp.onchange=e=>update(e,'urlTemplate'));
Â Â container.querySelectorAll('.linkTemplate').forEach(inp=>inp.onchange=e=>update(e,'linkTemplate'));
Â Â container.querySelectorAll('.rateType').forEach(sel=>sel.onchange=e=>update(e,'rateType'));
Â Â container.querySelectorAll('.parseType').forEach(sel=>sel.onchange=e=>update(e,'parseType'));
Â Â container.querySelectorAll('.parsePath').forEach(inp=>inp.onchange=e=>update(e,'parsePath'));
Â Â container.querySelectorAll('.mappings').forEach(ta=>ta.onchange=e=>update(e,'mappings'));
Â Â container.querySelectorAll('.apiKey').forEach(inp=>inp.onchange=e=>update(e,'apiKey'));
Â Â container.querySelectorAll('.headers').forEach(ta=>ta.onchange=e=>update(e,'headers')); // ğŸ”¹ ç¬¬2å¤„ï¼šç›‘å¬ headers å˜åŒ–
Â Â container.querySelectorAll('.del').forEach(btn=>btn.onclick=e=>{adapters.splice(Number(e.target.dataset.i),1);renderAdapters();});
}

document.getElementById('addAdapter').onclick = () => {
Â Â adapters.push({ 
Â Â Â Â name:'æ–°äº¤æ˜“æ‰€', 
Â Â Â Â urlTemplate:'https://api.example.com?from={{from}}&to={{to}}&fromChain={{fromNetwork}}&toChain={{toNetwork}}', 
Â Â Â Â method:'GET', 
Â Â Â Â parseType:'json', 
Â Â Â Â parsePath:'data.rate', 
Â Â Â Â linkTemplate:'https://example.com/{{from}}-{{to}}/{{fromNetwork}}-{{toNetwork}}', 
Â Â Â Â rateType:'floating',
Â Â Â Â mappings: {},
Â Â Â Â apiKey: '',
Â Â Â Â headers: {} // ğŸ”¹ ç¬¬3å¤„ï¼šåˆå§‹åŒ– headers å­—æ®µ
Â Â });
Â Â renderAdapters();
};

function disableAdminIfNoWorker() {
Â Â const disabled = !WORKER_URL || WORKER_URL === 'YOUR_WORKER_URL_HERE';
Â Â const loadBtn = document.getElementById('loadFromKV');
Â Â const saveBtn = document.getElementById('saveToKV');
Â Â const compareBtn = document.getElementById('compare');
Â Â loadBtn.disabled = disabled;
Â Â saveBtn.disabled = disabled;
Â Â compareBtn.disabled = disabled;
Â Â if (disabled) {
Â Â Â Â document.getElementById('status').textContent = 'è¯·å…ˆè®¾ç½® WORKER_URLï¼ˆå½“å‰ä¸ºå ä½ç¬¦ï¼‰ï¼Œä»¥å¯ç”¨è¯·æ±‚åŠŸèƒ½';
Â Â } else {
Â Â Â Â document.getElementById('status').textContent = 'Worker æ­£å¸¸è¿è¡Œã€‚';
Â Â }
}
disableAdminIfNoWorker();

document.getElementById('loadFromKV').onclick = async () => {
Â Â const pass = document.getElementById('adminPass').value.trim();
Â Â if (!pass) return alert('è¯·è¾“å…¥ç®¡ç†å¯†ç ');
Â Â try {
Â Â Â Â const res = await fetch(WORKER_URL + '/getConfig', {
Â Â Â Â Â Â method: 'POST',
Â Â Â Â Â Â headers: { 'content-type': 'application/json' },
Â Â Â Â Â Â body: JSON.stringify({ pass })
Â Â Â Â });
Â Â Â Â if (!res.ok) {
Â Â Â Â Â Â const txt = await res.text();
Â Â Â Â Â Â throw new Error(txt || ('HTTP ' + res.status));
Â Â Â Â }
Â Â Â Â const json = await res.json();
Â Â Â Â adapters = json.adapters || [];
Â Â Â Â 
Â Â Â Â // **å‰ç«¯ä¿®æ”¹ç‚¹ 1: åŒæ­¥å¡«å…… API Key**
Â Â Â Â if (json.CHANGENOW_API_KEY) {
Â Â Â Â Â Â document.getElementById('api-key').value = json.CHANGENOW_API_KEY;
Â Â Â Â }
Â Â Â Â 
Â Â Â Â alert('å·²ä»åç«¯åŠ è½½é…ç½®');
Â Â Â Â renderAdapters();
Â Â } catch (err) {
Â Â Â Â alert('åŠ è½½å¤±è´¥ï¼š' + err.message);
Â Â } finally {
Â Â Â Â try { document.getElementById('adminPass').value = ''; } catch(e){}
Â Â }
};

document.getElementById('saveToKV').onclick = async () => {
Â Â const pass = document.getElementById('adminPass').value.trim();
Â Â if (!pass) return alert('è¯·è¾“å…¥ç®¡ç†å¯†ç ');
Â Â try {
Â Â Â Â const res = await fetch(WORKER_URL + '/saveConfig', {
Â Â Â Â Â Â method: 'POST',
Â Â Â Â Â Â headers: { 'content-type': 'application/json' },
Â Â Â Â Â Â // **é€‚é…å™¨ä¿å­˜æ—¶åªä¼  adaptersï¼Œè®©åç«¯åˆå¹¶**
Â Â Â Â Â Â body: JSON.stringify({ pass, adapters }) 
Â Â Â Â });
Â Â Â Â const txt = await res.text();
Â Â Â Â if (!res.ok) throw new Error(txt || ('HTTP ' + res.status));
Â Â Â Â alert(txt);
Â Â } catch (err) {
Â Â Â Â alert('ä¿å­˜å¤±è´¥ï¼š' + err.message);
Â Â } finally {
Â Â Â Â try { document.getElementById('adminPass').value = ''; } catch(e){}
Â Â }
};

document.getElementById('compare').onclick = async ()=>{
Â Â const from=document.getElementById('from').value.trim().toUpperCase();
Â Â const to=document.getElementById('to').value.trim().toUpperCase();
Â Â const fromNetwork=document.getElementById('fromNetwork').value.trim().toUpperCase();
Â Â const toNetwork=document.getElementById('toNetwork').value.trim().toUpperCase();
Â Â const amountRaw = document.getElementById('amount').value.trim();
Â Â const amount = Number(amountRaw);
Â Â if(!from||!to)return alert('è¯·è¾“å…¥å¸ç§');
Â Â if (isNaN(amount) || amount <= 0 || amount > 10000) return alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°é‡ (å¤§äº 0 ä¸”ä¸è¶…è¿‡ 10000)');

Â Â queryPair = { from, to, fromNetwork, toNetwork, amount }; 

Â Â document.getElementById('status').textContent='æŸ¥è¯¢ä¸­...';
Â Â document.querySelector('#floatingTable tbody').innerHTML='';
Â Â document.querySelector('#lockedTable tbody').innerHTML='';
Â Â document.getElementById('floatingSummary').style.display='none';
Â Â document.getElementById('lockedSummary').style.display='none';
Â Â document.getElementById('copyJson').style.display='none';

Â Â const controller = new AbortController();
Â Â const timeout = setTimeout(()=>controller.abort(), 12000);

Â Â try{
Â Â Â Â const res=await fetch(WORKER_URL, {
Â Â Â Â Â Â method:'POST', headers:{'content-type':'application/json'}, signal: controller.signal,
Â Â Â Â Â Â body: JSON.stringify({ pair: queryPair, adapters })
Â Â Â Â });
Â Â Â Â if (!res.ok) throw new Error(`HTTP é”™è¯¯: ${res.status}`);
Â Â Â Â const results=await res.json();
Â Â Â Â lastResults = results;
Â Â Â Â showResults(results);
Â Â Â Â document.getElementById('status').textContent=`æŸ¥è¯¢å®Œæˆï¼Œå…± ${results.results.length} æ¡ç»“æœ`;
Â Â Â Â document.getElementById('copyJson').style.display='inline-block';
Â Â }catch(e){
Â Â Â Â if (e.name === 'AbortError') {
Â Â Â Â Â Â document.getElementById('status').textContent='å¤±è´¥: è¯·æ±‚è¶…æ—¶';
Â Â Â Â } else {
Â Â Â Â Â Â document.getElementById('status').textContent='å¤±è´¥: '+e.message;
Â Â Â Â }
Â Â } finally {
Â Â Â Â clearTimeout(timeout);
Â Â }
};

document.getElementById('copyJson').onclick = () => {
Â Â if (!lastResults) return alert('æ— ç»“æœå¯å¤åˆ¶');
Â Â navigator.clipboard.writeText(JSON.stringify(lastResults, null, 2)).then(() => {
Â Â Â Â alert('å·²å¤åˆ¶ JSON åˆ°å‰ªè´´æ¿');
Â Â }).catch(() => {
Â Â Â Â alert('å¤åˆ¶å¤±è´¥');
Â Â });
};

async function saveConfig() {
Â Â const adminPass = document.getElementById('admin-pass').value;
Â Â const apiKey = document.getElementById('api-key').value;

Â Â const res = await fetch(`${WORKER_URL}/saveConfig`, {
Â Â Â Â method: 'POST',
Â Â Â Â headers: { 'Content-Type': 'application/json' },
Â Â Â Â // **ä¿®å¤ç‚¹ 2: ä¿®æ­£å¯†ç å­—æ®µåä¸º password**
Â Â Â Â body: JSON.stringify({
Â Â Â Â Â Â password: adminPass,
Â Â Â Â Â Â config: { CHANGENOW_API_KEY: apiKey }
Â Â Â Â })
Â Â });

Â Â const data = await res.text();
Â Â alert(data);
}

function showResults(results){
Â Â const floating = results.results.filter(r=>r.rateType==='floating');
Â Â const locked = results.results.filter(r=>r.rateType==='locked');
Â Â 
Â Â const sortFn=(a,b)=>{
Â Â Â Â const ao = (a && a.outputAmount != null) ? a.outputAmount : -Infinity;
Â Â Â Â const bo = (b && b.outputAmount != null) ? b.outputAmount : -Infinity;
Â Â Â Â if (ao === -Infinity && bo === -Infinity) return 0;
Â Â Â Â if (ao === -Infinity) return 1;
Â Â Â Â if (bo === -Infinity) return -1;
Â Â Â Â return bo - ao;
Â Â };
Â Â 
Â Â floating.sort(sortFn);
Â Â locked.sort(sortFn);
Â Â 
Â Â renderTable(floating,'#floatingTable tbody');
Â Â renderTable(locked,'#lockedTable tbody');
Â Â 
Â Â renderSummary(floating.filter(r => r.ok && r.rate != null), '#floatingSummary', floating[0], results.stats?.floating);
Â Â renderSummary(locked.filter(r => r.ok && r.rate != null), '#lockedSummary', locked[0], results.stats?.locked);
}

function renderTable(data,selector){
Â Â const tbody=document.querySelector(selector);tbody.innerHTML='';
Â Â if(!data.length){tbody.innerHTML='<tr><td colspan=4 style="text-align:center;color:#666;">æ— æ•°æ®</td></tr>';return;}
Â Â data.forEach((r,i)=>{
Â Â Â Â // **ä¿®å¤ç‚¹ 3: ä¿®æ­£ best æ ‡è®°é€»è¾‘**
Â Â Â Â // æ£€æŸ¥æ˜¯å¦æ˜¯æ’åºåçš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¸”æœ‰æœ‰æ•ˆè¾“å‡ºé‡ï¼Œä¸”è¾“å‡ºé‡ç­‰äºç¬¬ä¸€ä¸ªå…ƒç´ çš„è¾“å‡ºé‡ï¼ˆé˜²æ­¢å¹³å±€æ—¶æ ‡è®°å¤šä¸ªï¼‰
Â Â Â Â const best = i===0 && r.ok && r.outputAmount != null && data[0].outputAmount != null && r.outputAmount === data[0].outputAmount; 
Â Â Â Â 
Â Â Â Â const outputDisplay = r.ok && r.outputAmount != null 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ? Number(r.outputAmount).toFixed(6) + ' ' + queryPair.to
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â : '-';

Â Â Â Â const tr = document.createElement('tr');

Â Â Â Â const tdName = document.createElement('td');
Â Â Â Â tdName.innerHTML = (r.name || '-') + (best ? '<span class="best-mark">Best</span>' : '');

Â Â Â Â const tdRate = document.createElement('td');
Â Â Â Â if (r.ok && r.rate != null) {
Â Â Â Â Â Â if (best) {
Â Â Â Â Â Â Â Â const b = document.createElement('b');
Â Â Â Â Â Â Â Â b.style.color = 'red';
Â Â Â Â Â Â Â Â b.textContent = String(r.rate);
Â Â Â Â Â Â Â Â tdRate.appendChild(b);
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â tdRate.textContent = String(r.rate);
Â Â Â Â Â Â }
Â Â Â Â } else {
Â Â Â Â Â Â const spanErr = document.createElement('span');
Â Â Â Â Â Â spanErr.className = 'err';
Â Â Â Â Â Â spanErr.textContent = r.error || 'æ— ';
Â Â Â Â Â Â tdRate.appendChild(spanErr);
Â Â Â Â }

Â Â Â Â const tdOutput = document.createElement('td');
Â Â Â Â tdOutput.textContent = outputDisplay;

Â Â Â Â const tdOp = document.createElement('td');
Â Â Â Â if (r.ok && r.link && (r.link.startsWith('http://') || r.link.startsWith('https://'))) {
Â Â Â Â Â Â let safeHref = '#';
Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â const u = new URL(r.link);
Â Â Â Â Â Â Â Â if (u.protocol === 'http:' || u.protocol === 'https:') {
Â Â Â Â Â Â Â Â Â Â safeHref = u.toString();
Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â safeHref = '#';
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â } catch (e) {
Â Â Â Â Â Â Â Â safeHref = '#';
Â Â Â Â Â Â }
Â Â Â Â Â Â if (safeHref !== '#') {
Â Â Â Â Â Â Â Â const a = document.createElement('a');
Â Â Â Â Â Â Â Â a.href = safeHref;
Â Â Â Â Â Â Â Â a.target = '_blank';
Â Â Â Â Â Â Â Â a.rel = 'noopener noreferrer';
Â Â Â Â Â Â Â Â a.textContent = 'å‰å¾€';
Â Â Â Â Â Â Â Â tdOp.appendChild(a);
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â tdOp.textContent = '-';
Â Â Â Â Â Â }
Â Â Â Â } else {
Â Â Â Â Â Â tdOp.textContent = '-';
Â Â Â Â }

Â Â Â Â tr.appendChild(tdName);
Â Â Â Â tr.appendChild(tdRate);
Â Â Â Â tr.appendChild(tdOutput);
Â Â Â Â tr.appendChild(tdOp);
Â Â Â Â tbody.appendChild(tr);
Â Â });
}

function renderSummary(data, selector, bestResult, stats) {
Â Â Â Â const summaryDiv = document.querySelector(selector);
Â Â Â Â 
Â Â Â Â if (data.length === 0) {
Â Â Â Â Â Â Â Â summaryDiv.style.display = 'none';
Â Â Â Â Â Â Â Â return;
Â Â Â Â }
Â Â Â Â 
Â Â Â Â summaryDiv.style.display = 'block';
Â Â Â Â 
Â Â Â Â const rates = data.map(r => r.rate);
Â Â Â Â const sumRate = rates.reduce((a, b) => a + b, 0);
Â Â Â Â const avgRate = sumRate / rates.length;
Â Â Â Â 
Â Â Â Â const bestRate = bestResult.rate;
Â Â Â Â const bestOutput = bestResult.outputAmount.toFixed(6);

Â Â Â Â const fromCoin = queryPair.from;
Â Â Â Â const toCoin = queryPair.to;

Â Â Â Â let extra = '';
Â Â Â Â if (stats) {
Â Â Â Â Â Â extra = `
Â Â Â Â Â Â Â Â <p>æœ€ä½: <b>${stats.min.toFixed(6)}</b> | æœ€é«˜: <b>${stats.max.toFixed(6)}</b> | æ ‡å‡†å·®: <b>${stats.stddev.toFixed(6)}</b></p>
Â Â Â Â Â Â `;
Â Â Â Â }
Â Â Â Â 
Â Â Â Â summaryDiv.innerHTML = `
Â Â Â Â Â Â Â Â <p>è¾“å…¥é‡: <b><LaTex>${queryPair.amount} $</LaTex>{fromCoin}-${queryPair.fromNetwork}</b></p>
Â Â Â Â Â Â Â Â <p>æœ€ä¼˜æ±‡ç‡ (<LaTex>${bestResult.name}): <b>$</LaTex>{bestRate}</b> 
Â Â Â Â Â Â Â Â Â Â Â (é¢„ä¼°è¾“å‡º: <b><LaTex>${bestOutput} $</LaTex>{toCoin}</b>)</p>
Â Â Â Â Â Â Â Â <p>å¹³å‡æ±‡ç‡: <b>${avgRate.toFixed(6)}</b> 
Â Â Â Â Â Â Â Â Â Â Â (é¢„ä¼°è¾“å‡º: <b><LaTex>${(avgRate * queryPair.amount).toFixed(6)} $</LaTex>{toCoin}</b>)</p>
Â Â Â Â Â Â Â Â ${extra}
Â Â Â Â `;
}
</script>
</body>
</html>
