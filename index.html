<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>即时兑换汇率对比（多链版）</title>
<style>
  body { font-family: -apple-system, "Helvetica Neue", Arial; margin: 12px; }
  input, button, select, textarea { font-size: 15px; padding: 4px; border-radius: 4px; border: 1px solid #ccc; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align:left; }
  .ok { color: green; } .err { color: #c00; }
  .small { font-size: 13px; color: #666; }
  .adapter-item { border: 1px solid #eee; padding: 8px; margin: 6px 0; border-radius: 4px; background: #f9f9f9; }
  .section-title { margin-top: 20px; border-bottom: 2px solid #555; padding-bottom: 5px; }
  .config-area { border:1px solid #aaa;padding:8px;margin-top:16px;background:#f5f5f5;border-radius:4px; }
  .summary { margin-top: 15px; padding: 10px; border: 1px solid #eee; border-radius: 4px; background: #f0f8ff; }
  .summary b { font-size: 1.1em; }
  .best-mark { color: green; font-weight: bold; margin-left: 4px; }
  .small-muted { font-size:12px;color:#999;margin-left:6px;}
  .warn { color:#c60; font-weight:bold; }
</style>
</head>
<body>
<h2>即时兑换汇率对比（多链版）</h2>

<div>
  <label>币种From:<input id="from" value="BTC" style="width:80px"></label>
  <label>链From:<input id="fromNetwork" value="ETH" style="width:80px"></label>
  <label>币种To:<input id="to" value="USDT" style="width:80px"></label>
  <label>链To:<input id="toNetwork" value="SOL" style="width:80px"></label>
  <label>数量:<input id="amount" value="1" style="width:100px"></label>

  <label style="margin-left:12px;">
    <input type="radio" name="mode" id="modeFloating" value="floating" checked> 查浮动
  </label>
  <label>
    <input type="radio" name="mode" id="modeLocked" value="locked"> 查锁定
  </label>

  <button id="compare" style="margin-left:8px;">一键比价</button>
  <button id="copyJson" style="margin-left:8px; display:none;">复制 JSON</button>
</div>

<div id="status" class="small" style="margin:10px 0;">请设置 WORKER_URL</div>

<h4 style="color:#007bff;">浮动汇率</h4>
<table id="floatingTable">
  <thead><tr><th>交易所</th><th>预估收到</th><th>操作</th></tr></thead>
  <tbody></tbody>
</table>
<div id="floatingSummary" class="summary" style="display:none;"></div>

<h4 style="color:#28a745;">锁定汇率</h4>
<table id="lockedTable">
  <thead><tr><th>交易所</th><th>预估收到</th><th>操作</th></tr></thead>
  <tbody></tbody>
</table>
<div id="lockedSummary" class="summary" style="display:none;"></div>

<div class="config-area">
  <h3 class="section-title">交易所适配器管理（需密码）</h3>
  <div>
    <input id="adminPass" type="password" placeholder="输入管理密码" style="width:140px;">
    <button id="loadFromKV">从后端加载配置</button>
    <button id="saveToKV">保存到后端</button>
    <button id="addAdapter">新增交易所</button>
  </div>
  <div class="small">可添加或删除自定义交易所 API。配置保存到 Cloudflare Worker KV 中。建议为每个 adapter 填写 parsePath 与 rangePath，并可选填写 minAmount/maxAmount 用于前端预校验。</div>
  <div id="adapterList"></div>
</div>

<h2>全局配置管理</h2>
<div id="admin-panel" class="config-area">
  <input id="admin-pass" placeholder="管理密码" type="password" style="width:140px;" />
  <input id="api-key" placeholder="全局 API Key（可选）" style="width:240px;" />
  <button onclick="saveConfig()">保存全局配置</button>
  <div class="small-muted">全局 API Key 仅作 adapter 未提供 apiKey 时的回退。</div>
</div>

<script>
// ==================== 请修改为你的 Worker 地址 ====================
const WORKER_URL = 'https://your-worker.your-username.workers.dev';
// ==================================================================

let adapters = [];
let queryPair = {};
let lastResults = null;

function escapeHtml(s) {
  if (!s && s !== 0) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/'/g, '&#39;');
}

/* ---------- Render adapter editor (includes min/max fields for prevalidation) ---------- */
function renderAdapters() {
  const container = document.getElementById('adapterList');
  container.innerHTML = '';
  adapters.forEach((a, i) => {
    const mappingsJson = JSON.stringify(a.mappings || {}, null, 2);
    const headersJson = JSON.stringify(a.headers || {}, null, 2);
    const bodyJson = a.body ? (typeof a.body === 'object' ? JSON.stringify(a.body, null, 2) : a.body) : '';

    const div = document.createElement('div');
    div.className = 'adapter-item';
    div.innerHTML = `
      <b>${escapeHtml(a.name || ('适配器 ' + (i+1)))}</b><br>
      <div class="small">显示名称:
        <input data-i="${i}" class="name" value="${escapeHtml(a.name||'')}">
      </div>
      <div class="small">URL模板:
        <input data-i="${i}" class="url" value="${escapeHtml(a.urlTemplate||'')}">
      </div>
      <div class="small">链接模板:
        <input data-i="${i}" class="linkTemplate" value="${escapeHtml(a.linkTemplate||'')}">
      </div>
      <div class="small">
        <label>请求方法:
          <select data-i="${i}" class="method">
            <option value="GET" ${ (a.method||'GET').toUpperCase() === 'GET' ? 'selected' : '' }>GET</option>
            <option value="POST" ${ (a.method||'GET').toUpperCase() === 'POST' ? 'selected' : '' }>POST</option>
          </select>
        </label>
      </div>
      <div class="small">
        <label>类型:
          <select data-i="${i}" class="rateType">
            <option value="floating" ${a.rateType==='floating'?'selected':''}>浮动</option>
            <option value="locked" ${a.rateType==='locked'?'selected':''}>锁定</option>
          </select>
        </label>
      </div>
      <label>解析类型:
        <select data-i="${i}" class="parseType">
          <option value="json" ${a.parseType==='json'?'selected':''}>json</option>
          <option value="html_regex" ${a.parseType==='html_regex'?'selected':''}>html_regex</option>
        </select>
      </label>
      <label>parsePath (必须): 
        <input data-i="${i}" class="parsePath" value="${escapeHtml(a.parsePath||'')}">
      </label>
      <label>rangePath (必须，用于范围解析): 
        <input data-i="${i}" class="rangePath" value="${escapeHtml(a.rangePath||'')}">
      </label>
      <div class="small">
        <label>Headers (JSON):
          <textarea data-i="${i}" class="headers" style="width:90%; height:70px;">${escapeHtml(headersJson)}</textarea>
        </label>
      </div>
      <div class="small">
        <label>Body (JSON 或 表单字符串):
          <textarea data-i="${i}" class="body" style="width:90%; height:70px;">${escapeHtml(bodyJson)}</textarea>
        </label>
      </div>
      <div class="small">
        <label>币种/链名映射 (Mappings JSON): 
          <textarea data-i="${i}" class="mappings" style="width:90%; height: 80px;">${escapeHtml(mappingsJson)}</textarea>
        </label>
      </div>
      <div class="small">
        <label>API Key: 
          <input data-i="${i}" class="apiKey" value="${escapeHtml(a.apiKey||'')}">
        </label>
        <label style="margin-left:12px">minAmount:
          <input data-i="${i}" class="minAmount" value="${escapeHtml(a.minAmount!=null? a.minAmount : '')}" style="width:120px">
        </label>
        <label style="margin-left:8px">maxAmount:
          <input data-i="${i}" class="maxAmount" value="${escapeHtml(a.maxAmount!=null? a.maxAmount : '')}" style="width:120px">
        </label>
      </div>
      <button data-i="${i}" class="del">删除</button>
    `;
    container.appendChild(div);
  });

  const update = (e, p) => {
    const i = Number(e.target.dataset.i);
    if (p === 'mappings' || p === 'headers') {
      try {
        adapters[i][p] = JSON.parse(e.target.value || '{}');
      } catch (err) {
        alert('JSON 格式错误: ' + err.message);
        return;
      }
    } else if (p === 'body') {
      const val = e.target.value.trim();
      try { adapters[i].body = val ? JSON.parse(val) : ''; } catch { adapters[i].body = val; }
    } else if (p === 'minAmount' || p === 'maxAmount') {
      const v = e.target.value.trim();
      adapters[i][p] = v === '' ? undefined : Number(v);
    } else {
      adapters[i][p] = e.target.value;
    }
  };

  container.querySelectorAll('.name').forEach(inp => inp.onchange = e => update(e, 'name'));
  container.querySelectorAll('.url').forEach(inp => inp.onchange = e => update(e, 'urlTemplate'));
  container.querySelectorAll('.linkTemplate').forEach(inp => inp.onchange = e => update(e, 'linkTemplate'));
  container.querySelectorAll('.method').forEach(sel => sel.onchange = e => update(e, 'method'));
  container.querySelectorAll('.rateType').forEach(sel => sel.onchange = e => update(e, 'rateType'));
  container.querySelectorAll('.parseType').forEach(sel => sel.onchange = e => update(e, 'parseType'));
  container.querySelectorAll('.parsePath').forEach(inp => inp.onchange = e => update(e, 'parsePath'));
  container.querySelectorAll('.rangePath').forEach(inp => inp.onchange = e => update(e, 'rangePath'));
  container.querySelectorAll('.mappings').forEach(ta => ta.onchange = e => update(e, 'mappings'));
  container.querySelectorAll('.apiKey').forEach(inp => inp.onchange = e => update(e, 'apiKey'));
  container.querySelectorAll('.headers').forEach(ta => ta.onchange = e => update(e, 'headers'));
  container.querySelectorAll('.body').forEach(ta => ta.onchange = e => update(e, 'body'));
  container.querySelectorAll('.minAmount').forEach(inp => inp.onchange = e => update(e, 'minAmount'));
  container.querySelectorAll('.maxAmount').forEach(inp => inp.onchange = e => update(e, 'maxAmount'));
  container.querySelectorAll('.del').forEach(btn => btn.onclick = e => {
    adapters.splice(Number(e.target.dataset.i), 1);
    renderAdapters();
  });
}

document.getElementById('addAdapter').onclick = () => {
  adapters.push({
    name: '新交易所',
    urlTemplate: 'https://api.example.com?from={{from}}&to={{to}}&fromNetwork={{fromNetwork}}&toNetwork={{toNetwork}}&amount={{amount}}',
    method: 'GET',
    parseType: 'json',
    parsePath: 'estimatedAmount',
    rangePath: 'payload.range',
    linkTemplate: 'https://example.com/exchange?from={{from}}&to={{to}}',
    rateType: 'floating',
    mappings: {},
    apiKey: '',
    headers: {},
    body: '',
    minAmount: undefined,
    maxAmount: undefined
  });
  renderAdapters();
};

function disableAdminIfNoWorker() {
  const disabled = !WORKER_URL || WORKER_URL.includes('your-worker');
  document.getElementById('loadFromKV').disabled = disabled;
  document.getElementById('saveToKV').disabled = disabled;
  document.getElementById('compare').disabled = disabled;
  document.getElementById('status').textContent = disabled ? '请修改 WORKER_URL 为你的 Cloudflare Worker 地址' : 'Worker 已连接';
}
disableAdminIfNoWorker();

// load config from backend KV
document.getElementById('loadFromKV').onclick = async () => {
  const pass = document.getElementById('adminPass').value.trim();
  if (!pass) return alert('请输入管理密码');
  try {
    const res = await fetch(WORKER_URL + '/getConfig', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ pass })
    });
    if (!res.ok) throw new Error(await res.text() || 'HTTP ' + res.status);
    const json = await res.json();
    adapters = Array.isArray(json.adapters) ? json.adapters : [];
    // normalize numeric min/max if present as strings
    adapters.forEach(a => {
      if (a.minAmount != null) a.minAmount = Number(a.minAmount);
      if (a.maxAmount != null) a.maxAmount = Number(a.maxAmount);
    });
    if (json.CHANGENOW_API_KEY) document.getElementById('api-key').value = json.CHANGENOW_API_KEY;
    alert('配置加载成功');
    renderAdapters();
  } catch (err) {
    alert('加载失败：' + err.message);
  } finally {
    document.getElementById('adminPass').value = '';
  }
};

// save config to backend KV
document.getElementById('saveToKV').onclick = async () => {
  const pass = document.getElementById('adminPass').value.trim();
  if (!pass) return alert('请输入管理密码');
  try {
    const payloadAdapters = adapters.map(a => {
      const copy = { ...a };
      // ensure numeric fields are simple numbers or omitted
      if (copy.minAmount === undefined) delete copy.minAmount;
      if (copy.maxAmount === undefined) delete copy.maxAmount;
      return copy;
    });
    const res = await fetch(WORKER_URL + '/saveConfig', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ pass, adapters: payloadAdapters, config: { CHANGENOW_API_KEY: document.getElementById('api-key').value.trim() } })
    });
    const txt = await res.text();
    if (!res.ok) throw new Error(txt || 'HTTP ' + res.status);
    alert(txt);
  } catch (err) {
    alert('保存失败：' + err.message);
  } finally {
    document.getElementById('adminPass').value = '';
  }
};

// compare (main action)
document.getElementById('compare').onclick = async () => {
  const from = document.getElementById('from').value.trim().toUpperCase();
  const to = document.getElementById('to').value.trim().toUpperCase();
  const fromNetwork = document.getElementById('fromNetwork').value.trim().toUpperCase();
  const toNetwork = document.getElementById('toNetwork').value.trim().toUpperCase();
  const amountRaw = document.getElementById('amount').value.trim();
  const amount = Number(amountRaw);
  if (!from || !to) return alert('请输入币种');
  if (isNaN(amount) || amount <= 0 || amount > 1000000) return alert('数量必须是合法数字且在 0~1000000 之间');

  queryPair = { from, to, fromNetwork, toNetwork, amount };

  // select adapters for selected mode only
  const selectedMode = document.querySelector('input[name="mode"]:checked').value;
  const adaptersToSend = adapters.filter(a => (a.rateType || 'floating') === selectedMode);

  // --- pre-validation using adapter.minAmount/maxAmount ---
  const invalid = [];
  adaptersToSend.forEach(a => {
    if (a.maxAmount != null && !isNaN(Number(a.maxAmount)) && amount > Number(a.maxAmount)) {
      invalid.push({ name: a.name || 'unknown', max: a.maxAmount });
    } else if (a.minAmount != null && !isNaN(Number(a.minAmount)) && amount < Number(a.minAmount)) {
      invalid.push({ name: a.name || 'unknown', min: a.minAmount });
    }
  });
  if (invalid.length) {
    const msgs = invalid.map(it => it.max ? `${it.name} 最大 ${it.max}` : `${it.name} 最小 ${it.min}`);
    return alert('检测到金额超出某些交易所限制，已阻止查询：\n' + msgs.join('\n'));
  }

  document.getElementById('status').textContent = '查询中...';
  document.querySelector('#floatingTable tbody').innerHTML = '';
  document.querySelector('#lockedTable tbody').innerHTML = '';
  document.getElementById('floatingSummary').style.display = 'none';
  document.getElementById('lockedSummary').style.display = 'none';
  document.getElementById('copyJson').style.display = 'none';

  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 15000);

  try {
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      signal: controller.signal,
      body: JSON.stringify({ pair: queryPair, adapters: adaptersToSend })
    });
    if (!res.ok) {
      const txt = await res.text().catch(()=>null);
      throw new Error(txt || `HTTP ${res.status}`);
    }
    const results = await res.json();
    lastResults = results;
    showResults(results);
    const total = Array.isArray(results.results) ? results.results.length : 0;
    document.getElementById('status').textContent = `完成，共 ${total} 条`;
    document.getElementById('copyJson').style.display = 'inline-block';
  } catch (e) {
    document.getElementById('status').textContent = e.name === 'AbortError' ? '请求超时' : '错误: ' + e.message;
  } finally {
    clearTimeout(timeout);
  }
};

document.getElementById('copyJson').onclick = () => {
  if (!lastResults) return alert('无数据');
  navigator.clipboard.writeText(JSON.stringify(lastResults, null, 2))
    .then(() => alert('已复制到剪贴板'))
    .catch(() => alert('复制失败'));
};

async function saveConfig() {
  const password = document.getElementById('admin-pass').value.trim();
  const apiKey = document.getElementById('api-key').value.trim();
  if (!password) return alert('请输入密码');

  try {
    const res = await fetch(`${WORKER_URL}/saveConfig`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ pass: password, config: { CHANGENOW_API_KEY: apiKey } })
    });
    const txt = await res.text();
    if (!res.ok) throw new Error(txt);
    alert(txt);
  } catch (err) {
    alert('保存失败: ' + err.message);
  }
}

// show results: uses outputAmount directly (预计收到)
function showResults(results) {
  const floating = results.results.filter(r => r.rateType === 'floating');
  const locked = results.results.filter(r => r.rateType === 'locked');

  const sortFn = (a, b) => {
    const ao = a.outputAmount ?? -Infinity;
    const bo = b.outputAmount ?? -Infinity;
    return bo - ao;
  };

  floating.sort(sortFn);
  locked.sort(sortFn);

  renderTable(floating, '#floatingTable tbody');
  renderTable(locked, '#lockedTable tbody');

  renderSummary(floating.filter(r => r.ok && r.outputAmount != null), '#floatingSummary', floating[0], results.stats?.floating);
  renderSummary(locked.filter(r => r.ok && r.outputAmount != null), '#lockedSummary', locked[0], results.stats?.locked);
}

function renderTable(data, selector) {
  const tbody = document.querySelector(selector);
  tbody.innerHTML = '';
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan=3 style="text-align:center;color:#666;">无数据</td></tr>';
    return;
  }
  data.forEach((r, i) => {
    const best = i === 0 && r.ok && r.outputAmount != null;
    const outputDisplay = r.ok && r.outputAmount != null
      ? `${Number(r.outputAmount).toFixed(6)} ${queryPair.to}`
      : '-';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(r.name || '-')} ${best ? '<span class="best-mark">Best</span>' : ''}</td>
      <td style="color:#333">${r.ok ? `预计收到 <b>${escapeHtml(Number(r.outputAmount).toFixed(6))}</b> ${escapeHtml(queryPair.to)}` : `<span class="err">${escapeHtml(r.error||'失败')}</span>`}</td>
      <td>${r.ok && r.link && /^https?:\/\//i.test(r.link) ? `<a href="${escapeHtml(r.link)}" target="_blank" rel="noopener">前往</a>` : '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderSummary(data, selector, bestResult, stats) {
  const div = document.querySelector(selector);
  if (!data.length) { div.style.display = 'none'; return; }
  div.style.display = 'block';

  const outputs = data.map(r => Number(r.outputAmount));
  const avgOutput = outputs.reduce((a,b)=>a+b,0)/outputs.length;
  const bestOutput = bestResult ? Number(bestResult.outputAmount).toFixed(6) : 'N/A';

  // stats may be null or missing stddev
  let stddev = 'N/A';
  if (stats && stats.stddev != null) {
    stddev = Number(stats.stddev).toFixed(6);
  } else if (outputs.length > 1) {
    const variance = outputs.reduce((sum, v) => sum + Math.pow(v - avgOutput, 2), 0) / outputs.length;
    stddev = Math.sqrt(variance).toFixed(6);
  }

  const minStr = stats?.min != null ? Number(stats.min).toFixed(6) : 'N/A';
  const maxStr = stats?.max != null ? Number(stats.max).toFixed(6) : 'N/A';

  div.innerHTML = `
    <p>输入: <b>${escapeHtml(queryPair.amount)} ${escapeHtml(queryPair.from)} - ${escapeHtml(queryPair.fromNetwork)}</b></p>
    <p>最优 (<b>${escapeHtml(bestResult?.name || 'N/A')}</b>): <b>${bestOutput} ${escapeHtml(queryPair.to)}</b></p>
    <p>平均预计收到: <b>${Number(avgOutput).toFixed(6)} ${escapeHtml(queryPair.to)}</b></p>
    <p>最低: <b>${minStr}</b> | 最高: <b>${maxStr}</b> | 标准差: <b>${stddev}</b></p>
  `;
}
</script>
</body>
</html>
