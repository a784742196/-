<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å³æ—¶å…‘æ¢æ±‡ç‡å¯¹æ¯”ï¼ˆå¤šé“¾ç‰ˆï¼‰</title>
<style>
Â Â body { font-family: -apple-system, "Helvetica Neue", Arial; margin: 12px; }
Â Â input, button, select, textarea { font-size: 15px; padding: 4px; border-radius: 4px; border: 1px solid #ccc; }
Â Â table { width: 100%; border-collapse: collapse; margin-top: 10px; }
Â Â th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align:left; }
Â Â .ok { color: green; } .err { color: #c00; }
Â Â .small { font-size: 13px; color: #666; }
Â Â .adapter-item { border: 1px solid #eee; padding: 8px; margin: 6px 0; border-radius: 4px; background: #f9f9f9; }
Â Â .section-title { margin-top: 20px; border-bottom: 2px solid #555; padding-bottom: 5px; }
Â Â .config-area { border:1px solid #aaa;padding:8px;margin-top:16px;background:#f5f5f5;border-radius:4px; }
Â Â .summary { margin-top: 15px; padding: 10px; border: 1px solid #eee; border-radius: 4px; background: #f0f8ff; }
Â Â .summary b { font-size: 1.1em; }
Â Â .best-mark { color: green; font-weight: bold; margin-left: 4px; }
Â Â .rate-mode-switch { margin: 10px 0; }
Â Â .rate-mode-switch button { margin-right: 8px; padding: 6px 12px; }
Â Â .rate-mode-switch button.active { background: #007bff; color: white; }
</style>
</head>
<body>
<h2>å³æ—¶å…‘æ¢æ±‡ç‡å¯¹æ¯”ï¼ˆå¤šé“¾ç‰ˆï¼‰</h2>

<div>
Â Â <label>å¸ç§From:<input id="from" value="BTC" style="width:80px"></label>
Â Â <label>é“¾From:<input id="fromNetwork" value="BTC" style="width:80px"></label>
Â Â <label>å¸ç§To:<input id="to" value="USDT" style="width:80px"></label>
Â Â <label>é“¾To:<input id="toNetwork" value="ETH" style="width:80px"></label>
Â Â <label>æ•°é‡:<input id="amount" value="1" style="width:80px"></label>
Â Â <div class="rate-mode-switch">
Â Â Â Â <button data-mode="floating" class="active">æµ®åŠ¨æ±‡ç‡</button>
Â Â Â Â <button data-mode="locked">é”å®šæ±‡ç‡</button>
Â Â </div>
Â Â <button id="compare">ä¸€é”®æ¯”ä»·</button>
Â Â <button id="copyJson" style="margin-left:8px; display:none;">å¤åˆ¶ JSON</button>
</div>

<div id="status" class="small" style="margin:10px 0;">è¯·è®¾ç½® WORKER_URL</div>

<h4 style="color:#007bff;">æµ®åŠ¨æ±‡ç‡</h4>
<table id="floatingTable"><thead><tr><th>äº¤æ˜“æ‰€</th><th>æ±‡ç‡</th><th>é¢„ä¼°è¾“å‡ºé‡</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
<div id="floatingSummary" class="summary" style="display:none;"></div>

<h4 style="color:#28a745;">é”å®šæ±‡ç‡</h4>
<table id="lockedTable"><thead><tr><th>äº¤æ˜“æ‰€</th><th>æ±‡ç‡</th><th>é¢„ä¼°è¾“å‡ºé‡</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
<div id="lockedSummary" class="summary" style="display:none;"></div>

<div class="config-area">
Â Â <h3 class="section-title">äº¤æ˜“æ‰€é€‚é…å™¨ç®¡ç†ï¼ˆéœ€å¯†ç ï¼‰</h3>
Â Â <div>
Â Â Â Â <input id="adminPass" type="password" placeholder="è¾“å…¥ç®¡ç†å¯†ç " style="width:140px;">
Â Â Â Â <button id="loadFromKV">ä»åç«¯åŠ è½½é…ç½®</button>
Â Â Â Â <button id="saveToKV">ä¿å­˜åˆ°åç«¯</button>
Â Â Â Â <button id="addAdapter">æ–°å¢äº¤æ˜“æ‰€</button>
Â Â </div>
Â Â <div class="small">å¯æ·»åŠ æˆ–åˆ é™¤è‡ªå®šä¹‰äº¤æ˜“æ‰€ APIã€‚é…ç½®å°†ä¿å­˜åˆ° Cloudflare Worker KV ä¸­ã€‚</div>
Â Â <div id="adapterList"></div>
</div>

<h2>å…¨å±€é…ç½®ç®¡ç†</h2>
<div id="admin-panel" class="config-area">
Â Â <input id="admin-pass" placeholder="ç®¡ç†å¯†ç " type="password" style="width:140px;" />
Â Â <input id="api-key" placeholder="ChangeNOW API Key" style="width:240px;" />
Â Â <button onclick="saveConfig()">ä¿å­˜å…¨å±€é…ç½®</button>
</div>

<script>
// ==================== è¯·åœ¨æ­¤å¤„ä¿®æ”¹ä½ çš„ Worker åœ°å€ ====================
const WORKER_URL = 'https://winter-rice-b000.yanfei6868.workers.dev'; 
// ==================================================================

let adapters = [];
let queryPair = {}; 
let lastResults = null;
let currentRateMode = 'floating';

function escapeHtml(s) {
Â Â if (!s) return '';
Â Â return s
Â Â Â Â .replace(/&/g, '&amp;')
Â Â Â Â .replace(/"/g, '&quot;')
Â Â Â Â .replace(/</g, '&lt;')
Â Â Â Â .replace(/>/g, '&gt;')
Â Â Â Â .replace(/'/g, '&#39;');
}

function renderAdapters() {
Â Â const container = document.getElementById('adapterList');
Â Â container.innerHTML = '';
Â Â adapters.forEach((a, i) => {
Â Â Â Â const mappingsJson = JSON.stringify(a.mappings || {}, null, 2);
Â Â Â Â const headersJson = JSON.stringify(a.headers || {}, null, 2);

Â Â Â Â const div = document.createElement('div');
Â Â Â Â div.className = 'adapter-item';
Â Â Â Â div.innerHTML = `
Â Â Â Â Â Â <input data-i="${i}" class="adapter-name" value="${escapeHtml(a.name || 'æ–°äº¤æ˜“æ‰€')}" style="font-weight:bold;width:180px;">
Â Â Â Â Â Â <button data-i="${i}" class="del" style="float:right;">åˆ é™¤</button><br>
Â Â Â Â Â Â <div class="small">URLæ¨¡æ¿: 
Â Â Â Â Â Â Â Â <input data-i="${i}" class="url" value="${escapeHtml(a.urlTemplate||'')}">
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="small">é“¾æ¥æ¨¡æ¿: 
Â Â Â Â Â Â Â Â <input data-i="${i}" class="linkTemplate" value="${escapeHtml(a.linkTemplate||'')}">
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>ç±»å‹:
Â Â Â Â Â Â Â Â Â Â <select data-i="${i}" class="rateType">
Â Â Â Â Â Â Â Â Â Â Â Â <option value="floating" ${a.rateType==='floating'?'selected':''}>æµ®åŠ¨</option>
Â Â Â Â Â Â Â Â Â Â Â Â <option value="locked" ${a.rateType==='locked'?'selected':''}>é”å®š</option>
Â Â Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <label>è§£æç±»å‹:
Â Â Â Â Â Â Â Â <select data-i="${i}" class="parseType">
Â Â Â Â Â Â Â Â Â Â <option value="json" ${a.parseType==='json'?'selected':''}>json</option>
Â Â Â Â Â Â Â Â Â Â <option value="html_regex" ${a.parseType==='html_regex'?'selected':''}>html_regex</option>
Â Â Â Â Â Â Â Â </select>
Â Â Â Â Â Â </label>
Â Â Â Â Â Â <label>è·¯å¾„/Regex: 
Â Â Â Â Â Â Â Â <input data-i="${i}" class="parsePath" value="${escapeHtml(a.parsePath||'')}">
Â Â Â Â Â Â </label><br>
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>å¸ç§/é“¾åæ˜ å°„ (Mappings): 
Â Â Â Â Â Â Â Â Â Â <textarea data-i="${i}" class="mappings" style="width:90%; height: 80px;">${escapeHtml(mappingsJson)}</textarea>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>API Key: 
Â Â Â Â Â Â Â Â Â Â <input data-i="${i}" class="apiKey" value="${escapeHtml(a.apiKey||'')}">
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div class="small">
Â Â Â Â Â Â Â Â <label>è‡ªå®šä¹‰ Headers(JSON):
Â Â Â Â Â Â Â Â Â Â <textarea data-i="${i}" class="headers" style="width:90%; height:70px;">${escapeHtml(headersJson)}</textarea>
Â Â Â Â Â Â Â Â </label>
Â Â Â Â Â Â </div>
Â Â Â Â `;
Â Â Â Â container.appendChild(div);
Â Â });
}

// ===================== ğŸ”§ compare æŒ‰é’®ä¿®æ­£ç‰ˆ =====================
document.getElementById('compare').onclick = async () => {
Â Â const from = document.getElementById('from').value.trim().toUpperCase();
Â Â const to = document.getElementById('to').value.trim().toUpperCase();
Â Â const fromNetwork = document.getElementById('fromNetwork').value.trim().toUpperCase();
Â Â const toNetwork = document.getElementById('toNetwork').value.trim().toUpperCase();
Â Â const amount = Number(document.getElementById('amount').value.trim());
Â Â if (!from || !to) return alert('è¯·è¾“å…¥å¸ç§');
Â Â if (isNaN(amount) || amount <= 0 || amount > 10000) return alert('æ•°é‡å¿…é¡»åœ¨ 0~10000 ä¹‹é—´');

Â Â queryPair = { from, to, fromNetwork, toNetwork, amount };
Â Â document.getElementById('status').textContent = 'æŸ¥è¯¢ä¸­...';
Â Â ['#floatingTable tbody', '#lockedTable tbody'].forEach(s => document.querySelector(s).innerHTML = '');
Â Â ['#floatingSummary', '#lockedSummary'].forEach(s => document.querySelector(s).style.display = 'none');
Â Â document.getElementById('copyJson').style.display = 'none';

Â Â const controller = new AbortController();
Â Â const timeout = setTimeout(() => controller.abort(), 15000);

Â Â try {
Â Â Â Â const res = await fetch(WORKER_URL, {
Â Â Â Â Â Â method: 'POST',
Â Â Â Â Â Â headers: { 'content-type': 'application/json' },
Â Â Â Â Â Â signal: controller.signal,
Â Â Â Â Â Â body: JSON.stringify({ pair: queryPair, adapters, rateMode: currentRateMode })
Â Â Â Â });
Â Â Â Â if (!res.ok) throw new Error(`HTTP ${res.status}`);
Â Â Â Â const results = await res.json(); // âœ… Worker è¿”å›çš„æ˜¯æ•°ç»„
Â Â Â Â lastResults = results;
Â Â Â Â showResults(results); // âœ… ç›´æ¥ä¼ å…¥æ•°ç»„
Â Â Â Â document.getElementById('status').textContent = `å®Œæˆï¼Œå…± ${results.length} æ¡`; // âœ… æ”¹ä¸º results.length
Â Â Â Â document.getElementById('copyJson').style.display = 'inline-block';
Â Â } catch (e) {
Â Â Â Â document.getElementById('status').textContent = e.name === 'AbortError' ? 'è¯·æ±‚è¶…æ—¶' : 'é”™è¯¯: ' + e.message;
Â Â } finally {
Â Â Â Â clearTimeout(timeout);
Â Â }
};

// ===================== ğŸ”§ showResults ä¿®æ­£ç‰ˆ =====================
function showResults(results) {
Â Â // âœ… ç°åœ¨ results å·²ç»æ˜¯æ•°ç»„ï¼Œä¸å†è®¿é—® results.results
Â Â const data = results.filter(r => r.rateType === currentRateMode);
Â Â 
Â Â const sortFn = (a, b) => {
Â Â Â Â if (a.ok !== b.ok) return a.ok ? -1 : 1;
Â Â Â Â const precisionA = a.outputAmount ? (a.outputAmount + '').split('.')[1]?.length || 0 : 0;
Â Â Â Â const precisionB = b.outputAmount ? (b.outputAmount + '').split('.')[1]?.length || 0 : 0;
Â Â Â Â if (precisionA !== precisionB) return precisionB - precisionA;
Â Â Â Â if (a.rate !== b.rate) return (b.rate || 0) - (a.rate || 0);
Â Â Â Â if (a.responseTime && b.responseTime) return a.responseTime - b.responseTime;
Â Â Â Â return 0;
Â Â };
Â Â 
Â Â data.sort(sortFn);
Â Â 
Â Â const tableId = currentRateMode === 'floating' ? '#floatingTable tbody' : '#lockedTable tbody';
Â Â const summaryId = currentRateMode === 'floating' ? '#floatingSummary' : '#lockedSummary';
Â Â 
Â Â renderTable(data, tableId);
Â Â renderSummary(data.filter(r => r.ok && r.rate != null), summaryId, data[0], null);
}

// å…¶ä½™è¾…åŠ©å‡½æ•°ä¿æŒä¸å˜
</script>
</body>
</html>
